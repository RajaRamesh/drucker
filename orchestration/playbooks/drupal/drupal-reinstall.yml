---
- include: playbooks/drupal/drupal-checkout.yml

- name: "REINSTALL: Check if drucker site exists"
  stat:
    path: "{{ drucker_site }}"
  register: drucker_site_reinstall_check
  ignore_errors: True

- name: "REINSTALL: Deletes drucker site"
  file:
    path: "{{ drucker_site }}"
    state: absent
  when: drucker_site_reinstall_check.stat.exists == true

- include: playbooks/drupal/drupal.yml

- name: Set up Drupal Console to work with the new docroot 1/2
  composer:
    command: require
    arguments: "{{ drupal_console_composer_package }}:{{ drupal_console_composer_package_version }} --prefer-dist --optimize-autoloader"
    working_dir: "{{ drucker_docroot }}"
  become: yes
  become_user: "{{ user }}"

- name: Set up Drupal Console to work with the new docroot 2/2
  composer:
    command: update
    arguments: "{{ drupal_console_composer_package }} --with-dependencies"
    working_dir: "{{ drucker_docroot }}"
  become: yes
  become_user: "{{ user }}"

- name: Add new vendor files under version control
  shell: git -C {{ drucker_site }} add --all . && git -C {{ drucker_site }} commit -m "Extra commit for vendor files"
  become: yes
  become_user: "{{ user }}"
