---
- name: Check if PHP is installed
  stat:
    path: /etc/php5/fpm/php.ini
  register: fpm

- name: "Install PHP core packages"
  package:
    name: "{{ item }}"
    state: installed
  with_items:
    - php5-fpm
    - php5-cli
    - php5-common
    - php5-dev
  when: fpm.stat.exists == false

- name: "Install PHP extensions"
  package:
    name: "{{ item }}"
    state: installed
  with_items:
    - libapache2-mod-php5
    - php5-apcu
    - php5-curl
    - php5-gd
    - php5-memcached
    - php5-mysql
    - php5-xsl
  when: fpm.stat.exists == false

- name: "Harden PHP"
  lineinfile:
    dest: "/etc/php5/fpm/php.ini"
    regexp: "SSLProtocol all"
    line: "\tSSLProtocol all -SSLv2 -SSLv3"
  when: fpm.stat.exists == false

- name: "Add default timezone"
  lineinfile:
    dest: "/etc/php5/cli/php.ini"
    regexp: ";date.timezone ="
    line: "date.timezone = America/New_York"
  notify: Restart Apache
  when: fpm.stat.exists == false
