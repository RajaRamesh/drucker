---
- name: Clean up system packages
  package:
    name: "{{ item }}"
    state: absent
    purge: yes
  with_items:
  - vim-tiny

- name: Check if sources.list exists
  stat:
    path: "{{ sources_list }}"
  register: sources_list_check

- name: Deploy sources.list template with contrib and non-free repositories
  copy:
    src: "{{ sources_list_source_file }}"
    dest: "{{ sources_list }}"
    mode: 0644
  when: sources_list_check.stat.exists == false

- name: Check if codename exists in sources.list
  shell: grep -o "{{ codename }}" {{ sources_list }} | head -1 || echo "missing"
  register: sources_list_codename
  changed_when: sources_list_codename.stdout == "missing"

- name: Add Debian codename to sources.list template
  replace:
    dest: "{{ sources_list }}"
    regexp: '^(.*)CODENAME(.*)$'
    replace: '\1{{ codename }}\2'
  when: sources_list_codename.stdout == "missing"

- name: Check if APT needs to be refreshed
  shell: dpkg -l | awk '{print $2}' | grep -o git | head -1
  register: refresh_apt
  changed_when: refresh_apt == ''

- name: Refresh APT
  apt:
    update_cache: yes
  when: refresh_apt == ''

- name: Install system packages
  package:
    name: "{{ item }}"
    state: present
  with_items:
  - ack-grep
  - apt-transport-https
  - curl
  - dstat
  - exuberant-ctags
  - git
  - htop
  - iputils-ping
  # phantomjs secret dependency
  - libfontconfig1
  - logrotate
  - lsof
  - ncdu
  - netcat
  - net-tools
  - ntp
  - patchutils
  - strace
  - sysstat
  - telnet
  - tcpdump
  - time
  - vim-gtk
  - wget
  # Allows to resize (/usr/bin/resize) the prompt if $COLUMNS and $LINES are
  # suddenly messed up, e.g. in a tmux session.
  - xterm
  when: refresh_apt == ''

- name: Ensure NTP is running
  service:
    name: ntp
    state: started
    enabled: yes

- name: Check if .bash_aliases exist
  stat:
    path: "{{ bash_aliases }}"
  register: bash_aliases
  changed_when: bash_aliases.stat.exists == false

- name: Deploy .bash_aliases
  copy:
    src: "{{ bash_aliases_source_file}}"
    dest: "{{ home }}"
    mode: 0644
    owner: "{{ user }}"
    group: "{{ user }}"
  become: yes
  become_user: "{{ user }}"
  when: bash_aliases.stat.exists == false

- name: Check if .vimrc file exists
  stat:
    path: "{{ vimrc }}"
  register: vimrc
  changed_when: vimrc.stat.exists == false
  ignore_errors: True

- name: Deploy .vimrc file
  copy:
    src: "{{ vimrc_source_file }}"
    dest: "{{ home }}"
    mode: 0644
  become: yes
  become_user: "{{ user }}"
  when: vimrc.stat.exists == false

- name: Check if .vim directory exists
  stat:
    path: "{{ vim_dir }}"
  register: vim_dir
  changed_when: vim_dir.stat.exists == false
  ignore_errors: True

- name: Deploy .vim directory
  copy:
    src: "{{ vim_source_dir }}"
    dest: "{{ home }}"
    mode: 0755
  become: yes
  become_user: "{{ user }}"
  when: vim_dir.stat.exists == false

- name: Add www-data group to drucker account
  user:
    name: "{{ user }}"
    groups: "{{ apache_user}}"
    append: yes
