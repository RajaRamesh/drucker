---
- name: "TEST: Drupal needs to be correctly installed"
  stat:
    path: "{{ item }}"
  with_items:
    - "{{ webroot }}/{{ user }}"
    - "{{ webroot }}/{{ user }}/{{default_site}}/files"
    - "{{ webroot }}/{{ user }}/libraries"
    - "{{ webroot }}/{{ user }}/{{default_site}}/settings.php"
    - "{{ webroot }}/{{ user }}/sites/simpletest"
    - "{{ webroot }}/{{ user }}/.git"
    - "{{ webroot }}/{{ user }}/.gitignore"
    - /var/lib/mysql/{{ user }}
    - "{{ sites_enabled }}/{{ user }}.conf"
    - "{{ drush_aliases_path }}/{{ user }}.aliases.drushrc.php"
    - "{{ webroot }}/{{ user }}/core/phpunit.xml"
    - "{{ webroot }}/import"
    - "{{ webroot }}/import/archives"
  register: drupal
  failed_when: drupal.stat.exists == false

- name: "TEST: settings.php should hold the correct trusted_host_patterns setting"
  shell: grep -o "{{ user }}.local" {{ webroot }}/{{ user }}/{{default_site}}/settings.php || echo "missing"
  register: trusted_host_patterns
  changed_when: trusted_host_patterns == "missing"
  failed_when: trusted_host_patterns == "missing"

- name: "TEST: Make sure the codebase was added under version control"
  shell: git log --oneline | grep -o "Initial commit" || echo 'no commit'
  register: initial_commit
  changed_when: initial_commit == "no commit"
  failed_when: initial_commit == "no commit"

- name: "TEST: Ensure remote MySQL databases can be managed"
  shell: dpkg -l | grep "python-mysqldb"
  register: remote_db_management
  changed_when: remote_db_management == ''
