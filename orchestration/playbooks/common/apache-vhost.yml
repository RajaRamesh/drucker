- name: "COMMON: Check if new vHost exists"
  stat:
    path: "{{ sites_enabled }}/{{ sitename }}.conf"
  register: new_vhost_check
  ignore_errors: True

- name: "COMMON: Deploy default vHost template"
  copy:
    src: "{{ apache_template_source_file }}"
    dest: "{{ sites_available }}"
    mode: 0644
  when: new_vhost_check.stat.exists == false

- name: "COMMON: Rename default vHost template"
  command: mv {{ vhost_template }} {{ sites_available }}/{{ sitename }}.conf
  when: new_vhost_check.stat.exists == false

- name: "COMMON: Add support for php-fpm Fast-CGI"
  blockinfile:
    dest: "{{ sites_available }}/{{ sitename }}.conf"
    block: |6
                  ProxyPassMatch ^/(.*\.php(/.*)?)$ unix:/var/run/php/php{{ php_version }}-fpm.sock|fcgi://127.0.0.1:9000/var/www/html/SITENAME/docroot/
    insertafter: '^(.*)DocumentRoot(.*)$'
    marker: "# {mark} MANAGED PHP-FPM FAST-CGI BLOCK"
  when: new_vhost_check.stat.exists == false

- name: "COMMON: Modify new vHost"
  replace:
    dest: "{{ sites_available }}/{{ sitename }}.conf"
    regexp: '^(.*)SITENAME(.*)$'
    replace: '\1{{ sitename }}\2'
  when: new_vhost_check.stat.exists == false

- name: "COMMON: Enable new vHost"
  file:
    src: ../sites-available/{{ sitename }}.conf
    dest: "{{ sites_enabled }}/{{ sitename }}.conf"
    state: link
    force: yes
  register: test
  notify: Reload Apache
  when: new_vhost_check.stat.exists == false
